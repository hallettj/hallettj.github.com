
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>sitr.us</title>
  <meta name="author" content="Jesse Hallett">

  
  <meta name="description" content="I have a long-standing desire for a JavaScript library that provides good implementations of functional data structures. Recently I found Mori, and I &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- OpenID delegation -->
  <meta http-equiv="X-XRDS-Location" content="http://www.myopenid.com/xrds?username=hallettj.myopenid.com" />
  <link rel="openid.server" href="http://www.myopenid.com/server" />
  <link rel="openid.delegate" href="http://hallettj.myopenid.com/" />
  <link rel="openid2.local_id" href="http://hallettj.myopenid.com" />
  <link rel="openid2.provider" href="http://www.myopenid.com/server" />

  
  <link rel="canonical" href="http://sitr.us/index.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  <link href="http://feeds.feedburner.com/hallettj" rel="alternate" title="sitr.us" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-327628-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sitr.us</a></h1>
  
    <h2>posts by Jesse Hallett</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/hallettj" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sitr.us" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2013/11/04/functional-data-structures.html">Functional data structures in JavaScript with Mori</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-04T00:00:00-08:00" pubdate data-updated="true">2013-11-04</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I have a long-standing desire for a JavaScript library that provides good implementations of functional data structures. Recently I found <a href='http://swannodette.github.io/mori/'>Mori</a>, and I think that it may be just the library that I have been looking for. Mori packages data structures from the <a href='http://clojure.org/'>Clojure</a> standard library for use in JavaScript code.</p>

<p>A functional data structure (also called a persistent data structure) has two important qualities: it is immutable and it can be updated by creating a copy with modifications (copy-on-write). Creating copies should be nearly as cheap as modifying a comparable mutable data structure in place. This is achieved with structural sharing: pointers to unchanged portions of a structure are shared between copies so that memory need only be allocated for changed portions of the data structure.</p>

<p>A simple example is a <a href='https://en.wikipedia.org/wiki/Linked_list'>linked list</a>. A linked list is an object, specifically a list node, with a value and a pointer to the next list node, which points to the next list node. (Eventually you get to the end of the list where there is a node that points to the empty list.) Prepending an element to the front of such a list is a constant-time operation: you just create a new list element with a pointer to the start of the existing list. When lists are immutable there is no need to actually copy the original list. Removing an element from the front of a list is also a constant-time operation: you just return a pointer to the second element of the list. Here is <a href='http://anorwell.com/index.php?id=61'>a slightly more-detailed explanation</a>.</p>

<p>Lists are just one example. There are functional implementations of maps, sets, and other types of structures.</p>

<p>Rich Hickey, the creator Clojure, describes functional data structures as <a href='http://clojure.org/state'>decoupling state and time</a>. (Also available in <a href='http://www.infoq.com/presentations/Are-We-There-Yet-Rich-Hickey'>video form</a>.) The idea is that code that uses functional data structures is easier to reason about and to verify than code that uses mutable data structures.</p>

<p><a href='http://clojure.org/'>Clojure</a> is a functional language that compiles to JVM bytecode. It is a Lisp dialect. Among Clojure&#8217;s innovations are implementations of a number of functional data structures, old and new. For example, other Lisps tend to place prime importance on linked lists; but a lot of Clojure code is based on <code>PersistentVector</code>, which supports efficient random-access operations.</p>

<p><a href='https://github.com/clojure/clojurescript'>ClojureScript</a> is an alternative Clojure compiler that produces JavaScript code instead of JVM bytecode. The team behind ClojureScript has ported Clojure collections to ClojureScript implementations - which are therefore within reach of JavaScript code.</p>

<p><a href='http://swannodette.github.io/mori/'>Mori</a> incorporates the ClojureScript build tool and pulls out just the standard library data structures. It builds a JavaScript file that can be used as a standalone library. Mori adds some API customizations to make the Clojure data structures easier to use in JavaScript - such as helpers to convert between JavaScript arrays and Clojure structures. Mori also includes a few helpers to make functional programming easier, like <code>identity</code>, <code>constant</code>, and <code>sum</code> functions. These are the data structures provided in the latest version of Mori, v0.2.4:</p>
<table><thead><tr><th>constructor</th><th>Mori</th><th>Clojure</th></tr></thead><tbody><tr><td style='text-align: left;'><code>list</code></td><td style='text-align: left;'><a href='http://swannodette.github.io/mori/#list'>Mori docs</a></td><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc13'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>vector</code></td><td style='text-align: left;'><a href='http://swannodette.github.io/mori/#vector'>Mori docs</a></td><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc15'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>range</code></td><td style='text-align: left;'><a href='http://swannodette.github.io/mori/#range'>Mori docs</a></td><td style='text-align: left;'><a href='http://clojuredocs.org/clojure_core/clojure.core/range'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>hash_map</code></td><td style='text-align: left;'><a href='http://swannodette.github.io/mori/#hash_map'>Mori docs</a></td><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc17'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>array_map</code></td><td style='text-align: left;' /><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc21'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>sorted_map</code></td><td style='text-align: left;' /><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc17'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>sorted_map_by</code></td><td style='text-align: left;' /><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc17'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>set</code></td><td style='text-align: left;'><a href='http://swannodette.github.io/mori/#set'>Mori docs</a></td><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc22'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>sorted_set</code></td><td style='text-align: left;'><a href='http://swannodette.github.io/mori/#sorted_set'>Mori docs</a></td><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc22'>Clojure docs</a></td>
</tr><tr><td style='text-align: left;'><code>sorted_set_by</code></td><td style='text-align: left;' /><td style='text-align: left;'><a href='http://clojure.org/data_structures#toc22'>Clojure docs</a></td>
</tr></tbody></table>
<p>All of these data structures are immutable and can be efficiently updated via copying and structural sharing.</p>

<p>The documentation for Mori is pretty good. But it does skip over some of the available data structures and functions. Since most of the stuff provided by Mori comes from Clojure, if you cannot find information that you need in the Mori docs you can also look at the Clojure docs. I provided links to the Clojure documentation for each data structure where more detailed descriptions are available.</p>

<h2 id='examples'>Examples</h2>

<p>Let&#8217;s take a look at the particular advantages of some of these structures.</p>

<h3 id='id1'><code>vector</code></h3>

<p>A vector is an ordered, finite sequence that supports efficient random-access lookups and updates. Vectors are created using the <a href='http://swannodette.github.io/mori/#vector'><code>vector</code></a> function from the <code>&#39;mori&#39;</code> module. Any arguments given to the function become elements of a new vector. In <a href='http://nodejs.org/'>Node.js</a> you can import Mori and create a vector like this:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>mori</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;mori&#39;</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>v</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>vector</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>);</span>

<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>count</span><span class='p'>(</span><span class='nx'>v</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>3</span><span class='p'>);</span>  <span class='c1'>// `count` gives the length of the vector</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>first</span><span class='p'>(</span><span class='nx'>v</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>1</span><span class='p'>);</span>
</code></pre></div>
<p>Mori also works with <a href='https://github.com/amdjs/amdjs-api/wiki/AMD'>AMD</a> implementations (such as <a href='http://requirejs.org/'>RequireJS</a>) for use in browser code:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>define</span><span class='p'>([</span><span class='s1'>&#39;mori&#39;</span><span class='p'>],</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>v</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>vector</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>);</span>
<span class='p'>});</span>
</code></pre></div>
<p>Idiomatic Clojure is not object-oriented. The convention in Clojure is that instead of putting methods on objects / values, one defines functions that take values as arguments. Those functions are organized into modules to group related functions together. This approach makes a lot of sense when values are mostly immutable; and it avoids name collisions that sometimes come up in object-oriented code, since names are scoped by module instead of by object.<sup id='fnref:1'><a href='#fn:1' rel='footnote'>1</a></sup></p>

<p>Since Mori is an adaptation of Clojure code, it uses the same convention. Data structures created with Mori do not have methods. Instead all functionality is provided by functions exported by the <code>&#39;mori&#39;</code> module. That is why the code here uses expressions like <code>mori.count(v)</code> instead of <code>v.count()</code>.</p>

<p>Existing vectors can be modified:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>v1</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>vector</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>v2</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>conj</span><span class='p'>(</span><span class='nx'>v1</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>);</span>

<span class='nx'>assert</span><span class='p'>(</span><span class='nb'>String</span><span class='p'>(</span><span class='nx'>v2</span><span class='p'>)</span> <span class='o'>===</span> <span class='s1'>&#39;[1 2 3 4]&#39;</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nb'>String</span><span class='p'>(</span><span class='nx'>v1</span><span class='p'>)</span> <span class='o'>===</span> <span class='s1'>&#39;[1 2 3]&#39;</span><span class='p'>);</span>  <span class='c1'>// The original vector is unchanged.</span>
</code></pre></div>
<p><code>conj</code> is an idiom that is particular to Clojure. It inserts one or more values into a collection. It behaves differently with different collection types, using whatever insert strategy is most efficient for the given collection.<sup id='fnref:2'><a href='#fn:2' rel='footnote'>2</a></sup></p>

<h3 id='higherorder_functions'>higher-order functions</h3>

<p>Mori provides a number of higher-order functions. Here is an example that computes the sum of the even values in a collection:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>even_sum</span><span class='p'>(</span><span class='nx'>coll</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>evens</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>filter</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>is_even</span><span class='p'>,</span> <span class='nx'>coll</span><span class='p'>);</span>
    <span class='kd'>var</span> <span class='nx'>sum</span>   <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>reduce</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sum</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>evens</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='nx'>sum</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>even_sum</span><span class='p'>(</span><span class='nx'>v2</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>6</span><span class='p'>);</span>
</code></pre></div>
<p>Or, borrowing from <a href='http://swannodette.github.io/mori/#group_by'>an example</a> in the Mori documentation, one might compute a sum for even values and a separate sum for odd values:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>even_odd_sum</span><span class='p'>(</span><span class='nx'>coll</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>groups</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>group_by</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>is_even</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='o'>?</span> <span class='s1'>&#39;even&#39;</span> <span class='o'>:</span> <span class='s1'>&#39;odd&#39;</span><span class='p'>;</span>
    <span class='p'>},</span> <span class='nx'>coll</span><span class='p'>);</span>
    <span class='kd'>var</span> <span class='nx'>evens</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>groups</span><span class='p'>,</span> <span class='s1'>&#39;even&#39;</span><span class='p'>);</span>
    <span class='kd'>var</span> <span class='nx'>odds</span>  <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>groups</span><span class='p'>,</span> <span class='s1'>&#39;odd&#39;</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>array_map</span><span class='p'>(</span>
        <span class='s1'>&#39;even&#39;</span><span class='p'>,</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>reduce</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sum</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>evens</span><span class='p'>),</span>
        <span class='s1'>&#39;odd&#39;</span><span class='p'>,</span>  <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>reduce</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sum</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>odds</span><span class='p'>)</span>
    <span class='p'>);</span>
<span class='p'>}</span>

<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>even_odd_sum</span><span class='p'>(</span><span class='nx'>v2</span><span class='p'>),</span> <span class='s1'>&#39;even&#39;</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>6</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>even_odd_sum</span><span class='p'>(</span><span class='nx'>v2</span><span class='p'>),</span> <span class='s1'>&#39;odd&#39;</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>4</span><span class='p'>);</span>
</code></pre></div>
<p>The example above returns a map created with <a href='http://clojure.org/data_structures#toc21'><code>array_map</code></a>, which is a map implementation that works well with a small number of keys.</p>

<h3 id='id2'><code>sorted_set_by</code></h3>

<p>JavaScript does not have its own set implementation. (Though it looks like <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Set'>one will be introduced</a> in ECMAScript 6.) Sets are a feature that I often miss.</p>

<p>A sorted set is a heavenly blend of a sequence and a set. Any duplicate values that are added are ignored, and there is a specific ordering of elements. Unlike a list or a vector, ordering is not based on insertion, but is determined by comparisons between elements.</p>

<p>One possible use for a sorted set is to implement a priority queue. Consider an example of a calendar application. <code>sorted_set_by</code> takes a comparison function that is used to to maintain an ordering of added values. With the appropriate comparison appointments are added and are automatically sorted by date:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>Calendar</span><span class='p'>(</span><span class='nx'>appts</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>appts</span> <span class='o'>=</span> <span class='nx'>appts</span> <span class='o'>||</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sorted_set_by</span><span class='p'>(</span><span class='nx'>compare_appts</span><span class='p'>);</span>
    <span class='kd'>var</span> <span class='nx'>cal</span> <span class='o'>=</span> <span class='p'>{};</span>

    <span class='nx'>cal</span><span class='p'>.</span><span class='nx'>add</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>appt</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>with_appt</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>conj</span><span class='p'>(</span><span class='nx'>appts</span><span class='p'>,</span> <span class='nx'>appt</span><span class='p'>);</span>
        <span class='k'>return</span> <span class='nx'>Calendar</span><span class='p'>(</span><span class='nx'>with_appt</span><span class='p'>);</span>
    <span class='p'>};</span>

    <span class='nx'>cal</span><span class='p'>.</span><span class='nx'>upcoming</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>start</span><span class='p'>,</span> <span class='nx'>n</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>futureAppts</span> <span class='o'>=</span> <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>filter</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>)</span> <span class='p'>{</span>
            <span class='k'>return</span> <span class='nx'>a</span><span class='p'>.</span><span class='nx'>date</span> <span class='o'>&gt;=</span> <span class='nx'>start</span><span class='p'>;</span>
        <span class='p'>},</span> <span class='nx'>appts</span><span class='p'>);</span>
        <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>take</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>,</span> <span class='nx'>futureAppts</span><span class='p'>);</span>
    <span class='p'>};</span>

    <span class='k'>return</span> <span class='nx'>cal</span><span class='p'>;</span>
<span class='p'>}</span>

<span class='c1'>// Returns a number that is:</span>
<span class='c1'>// * positive, if a is larger</span>
<span class='c1'>// *     zero, if a and b are equal</span>
<span class='c1'>// * negative, if b is larger</span>
<span class='kd'>function</span> <span class='nx'>compare_appts</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>,</span> <span class='nx'>b</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>if</span> <span class='p'>(</span><span class='nx'>a</span><span class='p'>.</span><span class='nx'>date</span> <span class='o'>!==</span> <span class='nx'>b</span><span class='p'>.</span><span class='nx'>date</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='nx'>a</span><span class='p'>.</span><span class='nx'>date</span> <span class='o'>-</span> <span class='nx'>b</span><span class='p'>.</span><span class='nx'>date</span><span class='p'>;</span>
    <span class='p'>}</span>
    <span class='k'>else</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='p'>(</span><span class='nx'>a</span><span class='p'>.</span><span class='nx'>title</span><span class='p'>)</span> <span class='p'>.</span><span class='nx'>localeCompare</span> <span class='p'>(</span><span class='nx'>b</span><span class='p'>.</span><span class='nx'>title</span><span class='p'>);</span>
    <span class='p'>}</span>
<span class='p'>}</span>
</code></pre></div>
<p>Like the underlying set, this calendar implementation is immutable. When an appointment is added you get a new calendar value.</p>

<p>The comparison function for comparing appointments sorts appointments by date, and uses title as a secondary sort in case there are appointments with the same date and time. The sorted set uses this function to determine equality as well as ordering; so if it made comparisons using only the date field then the calendar would not accept multiple appointments with the same date and time.</p>

<p>Appointments can be added to a calendar and queried in date order:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>my_cal</span> <span class='o'>=</span> <span class='nx'>Calendar</span><span class='p'>().</span><span class='nx'>add</span><span class='p'>({</span>
    <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;Portland JavaScript Admirers&#39; Monthly Meeting&quot;</span><span class='p'>,</span>
    <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-25T19:00-0700&quot;</span><span class='p'>)</span>
<span class='p'>}).</span><span class='nx'>add</span><span class='p'>({</span>
    <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;Code &#39;n&#39; Splode Monthly Meeting&quot;</span><span class='p'>,</span>
    <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-24T19:00-0700&quot;</span><span class='p'>)</span>
<span class='p'>}).</span><span class='nx'>add</span><span class='p'>({</span>
    <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;WhereCampPDX 6&quot;</span><span class='p'>,</span>
    <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-28T09:00-0700&quot;</span><span class='p'>)</span>
<span class='p'>}).</span><span class='nx'>add</span><span class='p'>({</span>
    <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;Synesthesia Bike Tour&quot;</span><span class='p'>,</span>
    <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-22T15:00-0700&quot;</span><span class='p'>)</span>
<span class='p'>});</span>

<span class='kd'>var</span> <span class='nx'>now</span> <span class='o'>=</span> <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-20&quot;</span><span class='p'>);</span>  <span class='c1'>// or `new Date()` for the current time</span>
<span class='kd'>var</span> <span class='nx'>next_appts</span> <span class='o'>=</span> <span class='nx'>my_cal</span><span class='p'>.</span><span class='nx'>upcoming</span><span class='p'>(</span><span class='nx'>now</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>);</span>
<span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nx'>a</span><span class='p'>.</span><span class='nx'>title</span><span class='p'>;</span> <span class='p'>},</span> <span class='nx'>next_appts</span><span class='p'>);</span>
<span class='c1'>// (&quot;Synesthesia Bike Tour&quot; &quot;Code &#39;n&#39; Splode Monthly Meeting&quot;)</span>
</code></pre></div>
<p>Looks good! Now let&#8217;s add an undo feature. In case the user changes her mind about the last appointment that was added, the undo feature should recreate the previous state without that appointment. The implementation of <code>Calendar</code> is the same as before except that the constructor takes an additional optional argument, the <code>add</code> method passes a reference from one calendar value to the next, and there is a new <code>undo</code> method:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>Calendar</span><span class='p'>(</span><span class='nx'>appts</span><span class='p'>,</span> <span class='nx'>prev_cal</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='c1'>// ...</span>

    <span class='nx'>cal</span><span class='p'>.</span><span class='nx'>add</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>appt</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>with_appt</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>conj</span><span class='p'>(</span><span class='nx'>appts</span><span class='p'>,</span> <span class='nx'>appt</span><span class='p'>);</span>
        <span class='k'>return</span> <span class='nx'>Calendar</span><span class='p'>(</span><span class='nx'>with_appt</span><span class='p'>,</span> <span class='nx'>cal</span><span class='p'>);</span>
    <span class='p'>};</span>

    <span class='nx'>cal</span><span class='p'>.</span><span class='nx'>undo</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='nx'>prev_cal</span> <span class='o'>||</span> <span class='nx'>Calendar</span><span class='p'>();</span>
    <span class='p'>};</span>

    <span class='c1'>// ...</span>
<span class='p'>}</span>
</code></pre></div>
<p>Assuming the same set of appointments, we can use the <code>undo</code> method to step back to a state before the fourth appointment was added:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>my_prev_cal</span> <span class='o'>=</span> <span class='nx'>my_cal</span><span class='p'>.</span><span class='nx'>undo</span><span class='p'>();</span>

<span class='kd'>var</span> <span class='nx'>next_appts_</span> <span class='o'>=</span> <span class='nx'>my_prev_cal</span><span class='p'>.</span><span class='nx'>upcoming</span><span class='p'>(</span><span class='nx'>now</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>);</span>
<span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nx'>a</span><span class='p'>.</span><span class='nx'>title</span><span class='p'>;</span> <span class='p'>},</span> <span class='nx'>next_appts_</span><span class='p'>);</span>
<span class='c1'>// (&quot;Code &#39;n&#39; Splode Monthly Meeting&quot; &quot;Portland JavaScript Admirers&#39; Monthly Meeting&quot;)</span>
</code></pre></div>
<p>Immutability comes in handy in this scenario. It is trivial to step back in time.</p>

<p>Actually because <code>Calendar</code> is immutable, you don&#8217;t necessarily need a special method to get undo behavior:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>makeCalendar</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>cal_0</span> <span class='o'>=</span> <span class='nx'>Calendar</span><span class='p'>();</span>
    <span class='kd'>var</span> <span class='nx'>cal_1</span> <span class='o'>=</span> <span class='nx'>cal_0</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>({</span>
        <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;Portland JavaScript Admirers&#39; Monthly Meeting&quot;</span><span class='p'>,</span>
        <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-25T19:00-0700&quot;</span><span class='p'>)</span>
    <span class='p'>});</span>
    <span class='kd'>var</span> <span class='nx'>cal_2</span> <span class='o'>=</span> <span class='nx'>cal_1</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>({</span>
        <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;Code &#39;n&#39; Splode Monthly Meeting&quot;</span><span class='p'>,</span>
        <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-24T19:00-0700&quot;</span><span class='p'>)</span>
    <span class='p'>});</span>
    <span class='kd'>var</span> <span class='nx'>cal_3</span> <span class='o'>=</span> <span class='nx'>cal_2</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>({</span>
        <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;WhereCampPDX 6&quot;</span><span class='p'>,</span>
        <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-28T09:00-0700&quot;</span><span class='p'>)</span>
    <span class='p'>});</span>
    <span class='kd'>var</span> <span class='nx'>cal_4</span> <span class='o'>=</span> <span class='nx'>cal_3</span><span class='p'>.</span><span class='nx'>add</span><span class='p'>({</span>
        <span class='nx'>title</span><span class='o'>:</span> <span class='s2'>&quot;Synesthesia Bike Tour&quot;</span><span class='p'>,</span>
        <span class='nx'>date</span><span class='o'>:</span>  <span class='nb'>Date</span><span class='p'>.</span><span class='nx'>parse</span><span class='p'>(</span><span class='s2'>&quot;2013-09-22T15:00-0700&quot;</span><span class='p'>)</span>
    <span class='p'>});</span>

    <span class='kd'>var</span> <span class='nx'>toReturn</span> <span class='o'>=</span> <span class='nx'>cal_4</span><span class='p'>;</span>

    <span class='c1'>// No wait! Undo!!</span>
    <span class='nx'>toReturn</span> <span class='o'>=</span> <span class='nx'>cal_3</span><span class='p'>;</span>

    <span class='c1'>// That was close...</span>
    <span class='k'>return</span> <span class='nx'>toReturn</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre></div>
<p>I&#8217;m sure that the Synesthesia Bike Tour is a lot of fun. It&#8217;s just that when demonstrating an undo feature, something has to take the fall. That&#8217;s just the world that we live in, I suppose.</p>

<h3 id='id3'><code>hash_map</code></h3>

<p>All JavaScript objects are maps. But those can only use strings as keys.<sup id='fnref:3'><a href='#fn:3' rel='footnote'>3</a></sup> The <code>hash_map</code> provided by Mori can use any values as keys.</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>mori</span> <span class='o'>=</span> <span class='nx'>require</span><span class='p'>(</span><span class='s1'>&#39;mori&#39;</span><span class='p'>);</span>

<span class='kd'>var</span> <span class='nx'>a</span> <span class='o'>=</span> <span class='p'>{</span> <span class='nx'>foo</span><span class='o'>:</span> <span class='mi'>1</span> <span class='p'>};</span>
<span class='kd'>var</span> <span class='nx'>b</span> <span class='o'>=</span> <span class='p'>{</span> <span class='nx'>foo</span><span class='o'>:</span> <span class='mi'>2</span> <span class='p'>};</span>

<span class='kd'>var</span> <span class='nx'>map</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash_map</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>,</span> <span class='s1'>&#39;first&#39;</span><span class='p'>,</span> <span class='nx'>b</span><span class='p'>,</span> <span class='s1'>&#39;second&#39;</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>map</span><span class='p'>,</span> <span class='nx'>b</span><span class='p'>)</span> <span class='o'>===</span> <span class='s1'>&#39;second&#39;</span><span class='p'>);</span>
</code></pre></div>
<p>If you use plain JavaScript objects as keys they will be compared by reference identity. If you use Mori data structures as keys they will be compared by value using equality comparisons provided by ClojureScript.</p>

<p>Mori maps are immutable; so there is never a need to create defensive copies. An update operation produces a new map.</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>empty</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash_map</span><span class='p'>();</span>
<span class='kd'>var</span> <span class='nx'>m1</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>assoc</span><span class='p'>(</span><span class='nx'>empty</span><span class='p'>,</span> <span class='s1'>&#39;foo&#39;</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>m2</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>assoc</span><span class='p'>(</span><span class='nx'>m1</span><span class='p'>,</span> <span class='s1'>&#39;bar&#39;</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='s1'>&#39;nao&#39;</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>m3</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>dissoc</span><span class='p'>(</span><span class='nx'>m2</span><span class='p'>,</span> <span class='s1'>&#39;foo&#39;</span><span class='p'>);</span>

<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>m2</span><span class='p'>,</span> <span class='s1'>&#39;foo&#39;</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>1</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>m2</span><span class='p'>,</span> <span class='s1'>&#39;bar&#39;</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>2</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>m3</span><span class='p'>,</span> <span class='s1'>&#39;foo&#39;</span><span class='p'>)</span> <span class='o'>===</span> <span class='kc'>null</span><span class='p'>);</span>
</code></pre></div>
<p>The function <code>assoc</code> adds any number key-value pairs to a map; and <code>dissoc</code> removes keys.</p>

<p>All of this also applies to <code>array_map</code>, <code>sorted_map</code>, and <code>sorted_map_by</code>. See <a href='#different_map_and_set_implementations'>Different map and set implementations</a> below for information about those.</p>

<p>There is a common pattern in JavaScript of passing options objects to constructors to avoid having functions that take zillions of arguments. It is also common to have a set of default values for certain options. So code like this is pretty typical:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>opts</span> <span class='o'>=</span> <span class='nx'>_</span><span class='p'>.</span><span class='nx'>extend</span><span class='p'>({},</span> <span class='nx'>options</span><span class='p'>,</span> <span class='nx'>defaults</span><span class='p'>);</span>
</code></pre></div>
<p>I usually put in an empty object as the first argument to the Underscore <a href='http://underscorejs.org/#extend'><code>_.extend</code></a> call so that I get a new object instead of modifying the given options object in place. Modifying the options object could cause problems if it is reused somewhere outside of my constructor. An alternative to the defensive copy could be to use immutable Mori maps:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>MyFeature</span><span class='p'>(</span><span class='nx'>options</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>opts</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>into</span><span class='p'>(</span><span class='nx'>MyFeature</span><span class='p'>.</span><span class='nx'>defaults</span><span class='p'>,</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>js_to_clj</span><span class='p'>(</span><span class='nx'>options</span><span class='p'>));</span>

    <span class='k'>this</span><span class='p'>.</span><span class='nx'>getPosition</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>opts</span><span class='p'>,</span> <span class='s1'>&#39;position&#39;</span><span class='p'>);</span>
    <span class='p'>};</span>

    <span class='k'>this</span><span class='p'>.</span><span class='nx'>getDestroyOnClose</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
        <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>get</span><span class='p'>(</span><span class='nx'>opts</span><span class='p'>,</span> <span class='s1'>&#39;destroyOnClose&#39;</span><span class='p'>);</span>
    <span class='p'>};</span>
<span class='p'>}</span>

<span class='nx'>MyFeature</span><span class='p'>.</span><span class='nx'>defaults</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>into</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash_map</span><span class='p'>(),</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>js_to_clj</span><span class='p'>({</span>
    <span class='nx'>destroyOnClose</span><span class='o'>:</span> <span class='kc'>true</span><span class='p'>,</span>
    <span class='nx'>position</span><span class='o'>:</span> <span class='s1'>&#39;below&#39;</span>
    <span class='c1'>// etc...</span>
<span class='p'>}));</span>

<span class='kd'>var</span> <span class='nx'>feat</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>MyFeature</span><span class='p'>({</span> <span class='nx'>position</span><span class='o'>:</span> <span class='s1'>&#39;above&#39;</span> <span class='p'>});</span>
<span class='nx'>assert</span><span class='p'>(</span><span class='nx'>feat</span><span class='p'>.</span><span class='nx'>getPosition</span><span class='p'>()</span> <span class='o'>===</span> <span class='s1'>&#39;above&#39;</span><span class='p'>);</span>
</code></pre></div>
<p>The function <code>mori.into(coll, from)</code> adds all of the members of <code>from</code> into a copy of <code>coll</code>. Both <code>from</code> and <code>coll</code> can by any Mori collection.</p>

<p>That does still involve copying the input <code>options</code> object into a new Mori map. It is also possible to provide a Mori sequence as input to start with - <code>js_to_clj</code> will accept either a plain JavaScript object or a Mori collection:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>feat_</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>MyFeature</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash_map</span><span class='p'>(</span>
    <span class='s1'>&#39;position&#39;</span><span class='p'>,</span>       <span class='s1'>&#39;above&#39;</span><span class='p'>,</span>
    <span class='s1'>&#39;destroyOnClose&#39;</span><span class='p'>,</span> <span class='kc'>true</span>
<span class='p'>));</span>
</code></pre></div>
<p>There is probably no performance gain from using Mori in this situation. It is unlikely to matter anyway, since the structures involved are small. In situations with larger data structures, or where data is copied many times in a loop, Mori&#8217;s ability to create copies faster using less memory could make a difference.</p>

<p>But in my opinion applying immutability consistently - even where there are no significant performance gains - can simplify things.</p>

<h2 id='apples_to_apples'>Apples to apples</h2>

<p>The transformations that are available in Mori - <code>map</code>, <code>filter</code>, etc. - return lazy sequences no matter what the type of the input collection is. (See <a href='#laziness'>Laziness</a> below for an explanation of what laziness is). This is advantageous because the other collection implementations are not lazy. But what if you want to do something like create a new set based on an existing set? The answer is that you feed a lazy sequence into a new empty collection using the appropriate constructor or the <code>into</code> function, which dumps all of the content from one collection into another:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>s_1</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>set</span><span class='p'>([</span><span class='mi'>5</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>]);</span>
<span class='kd'>var</span> <span class='nx'>seq</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>pow</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>);</span> <span class='p'>},</span> <span class='nx'>s_1</span><span class='p'>);</span>

<span class='kd'>var</span> <span class='nx'>s_2</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>set</span><span class='p'>(</span><span class='nx'>seq</span><span class='p'>);</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>s_2</span><span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; #{25 16 9 4 1}</span>

<span class='kd'>var</span> <span class='nx'>empty_s</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sorted_set_by</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>,</span> <span class='nx'>b</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nx'>a</span> <span class='o'>-</span> <span class='nx'>b</span><span class='p'>;</span> <span class='p'>});</span>
<span class='kd'>var</span> <span class='nx'>s_3</span>     <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>into</span><span class='p'>(</span><span class='nx'>empty_s</span><span class='p'>,</span> <span class='nx'>seq</span><span class='p'>);</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>s_3</span><span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; #{1 4 9 16 25}</span>
</code></pre></div>
<p>Applying <code>map</code> to the first set is lazy - but building the second set with <code>into</code> is not. So a good practice is to avoid building non-lazy collection until the last possible moment.</p>

<p>An odd quirk in Mori is that the <code>set</code> constructor takes a collection argument, but most of the other constructors take individual values or key-value pairs. The <code>into</code> function behaves more consistently across data structure implementations.</p>

<p>You might want to write transformations that are polymorphic - that can operate on any type of collection and that return a collection of the same type. To do that use <code>mori.empty(coll)</code> to get an empty version of a given collection. This makes it possible to build a new collection without having to know which constructor was used to create the original.</p>

<p>Here is a function that removes <code>null</code> values from any Mori collection and that returns a collection of the same type:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>compact</span><span class='p'>(</span><span class='nx'>coll</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>into</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>empty</span><span class='p'>(</span><span class='nx'>coll</span><span class='p'>),</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>filter</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>elem</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>value</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>is_map</span><span class='p'>(</span><span class='nx'>coll</span><span class='p'>)</span> <span class='o'>?</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>last</span><span class='p'>(</span><span class='nx'>elem</span><span class='p'>)</span> <span class='o'>:</span> <span class='nx'>elem</span><span class='p'>;</span>
        <span class='k'>return</span> <span class='nx'>value</span> <span class='o'>!==</span> <span class='kc'>null</span><span class='p'>;</span>
    <span class='p'>},</span> <span class='nx'>coll</span><span class='p'>));</span>
<span class='p'>}</span>
</code></pre></div>
<p>If the collection given is a map then the value of <code>elem</code> in the filter callback will be a key-value pair. So <code>compact</code> includes an <code>is_map</code> check and extracts the value from that key-value pair if a map is given.</p>

<p>A nice advantage of <code>empty</code> is that if you use it on a <code>sorted_set_by</code> or on a <code>sorted_map_by</code>, the new collection will inherit the same comparison function that the original uses.</p>

<h2 id='mori_pairs_well_with_bacon'>Mori pairs well with Bacon</h2>

<p>In a previous post, <a href='/2013/05/22/functional-reactive-programming-in-javascript.html'>Functional Reactive Programming in JavaScript</a>, I wrote about functional reactive programming (FRP) using <a href='https://github.com/raimohanska/bacon.js'>Bacon.js</a> and <a href='https://github.com/Reactive-Extensions/RxJS'>RxJS</a>. A typical assumption in FRP code is that values contained in events and properties will never be updated in place. The immutable data structures that Mori provides are a perfect fit.</p>

<h2 id='list_versus_vector'>List versus Vector</h2>

<p>Linked lists are nice and simple - but become less appealing when it becomes desirable to access elements at arbitrary positions in a sequence, to append elements to the end of a sequence, or to update elements at arbitrary indexes. The running time for all of these operations on lists is linear, and the append and update operations require creating a full copy of the list up to the changed position.</p>

<p>Clojure&#8217;s PersistentVector is a sequence, like a list. But under-the-hood it is implemented as a tree with 32-way branching. That means that any vector index can be looked up in O(log_32 n) time. Appending and updating arbitrary elements also takes place in logarithmic time. For more details read <a href='http://web.archive.org/web/20130119231848/http://blog.higher-order.net/2009/02/01/understanding-clojures-persistentvector-implementation/'>Understanding Clojure&#8217;s PersistentVector implementation</a>.</p>

<p>Sequences that are implemented as mutable arrays of contiguous memory support constant-time lookups and modification (not including array resizing when array length grows). If O(log_32 n) does not seem appealing in comparison, consider that if you are using 32-bit integers as keys:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>max_int</span> <span class='o'>=</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>pow</span><span class='p'>(</span><span class='mi'>2</span><span class='p'>,</span> <span class='mi'>32</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>log_32</span>  <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='o'>/</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='mi'>32</span><span class='p'>);</span> <span class='p'>};</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>log_32</span><span class='p'>(</span><span class='nx'>max_int</span><span class='p'>)</span> <span class='o'>&lt;</span> <span class='mi'>7</span> <span class='p'>);</span>
</code></pre></div>
<p>Which means that your keyspace will run out before your vector&#8217;s tree becomes more than 7 layers deep. Up to that point operations will be O(7) or faster.</p>

<p>If your keys are JavaScript numbers, which are 64-bit floating point values, the largest integer that you can count up to without skipping any numbers is <code>Math.pow(2, 53)</code>. The logarithm of that number is also small:</p>

<pre><code>assert( log_32(Math.pow(2, 53)) &lt; 11 );</code></pre>

<p>The <code>hash_map</code> and <code>set</code> implementations in Mori are also implemented as trees with 32-way branching. The sorted map and set structures are implemented as binary trees.</p>

<h2 id='equality_ordering_and_hashing'>Equality, ordering, and hashing</h2>

<p>Map and set lookups are based on either hashing or ordering comparisons, depending on the implementation. JavaScript does not have built-in hash functions - at least not that are accessible to library code. It also does not have defined ordering or equality for most non-primitive values. So Mori uses its own functions, which it gets from ClojureScript.</p>

<h3 id='hash'>hash</h3>

<p>Every Mori value has a hash that identifies its content:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>v</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>vector</span><span class='p'>(</span><span class='s1'>&#39;foo&#39;</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='nx'>v</span><span class='p'>)</span> <span class='o'>===</span> <span class='o'>-</span><span class='mi'>1634041171</span> <span class='p'>);</span>
</code></pre></div>
<p>If a value is recreated with the same content, it has the same hash:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>v2</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>vector</span><span class='p'>(</span><span class='s1'>&#39;foo&#39;</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='nx'>v2</span><span class='p'>)</span> <span class='o'>===</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='nx'>v</span><span class='p'>)</span> <span class='p'>);</span>
</code></pre></div>
<p>Mori&#8217;s hash function delegates to a specific hash algorithm for each of its data structures, which are ultimately based on internal algorithms that Mori uses to compute hashes for primitive JavaScript values:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='mi'>2</span><span class='p'>)</span>         <span class='o'>===</span> <span class='mi'>2</span>      <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='s2'>&quot;2&quot;</span><span class='p'>)</span>       <span class='o'>===</span> <span class='mi'>50</span>     <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='s2'>&quot;foo&quot;</span><span class='p'>)</span>     <span class='o'>===</span> <span class='mi'>101574</span> <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='kc'>true</span><span class='p'>)</span>      <span class='o'>===</span> <span class='mi'>1</span>      <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='kc'>false</span><span class='p'>)</span>     <span class='o'>===</span> <span class='mi'>0</span>      <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='kc'>null</span><span class='p'>)</span>      <span class='o'>===</span> <span class='mi'>0</span>      <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='kc'>undefined</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>0</span>      <span class='p'>);</span>
</code></pre></div>
<p>Since Mori also accommodates arbitrary JavaScript values as map keys and set values, it also has a scheme for assigning hash values to other JavaScript objects.</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>obj</span> <span class='o'>=</span> <span class='p'>{</span> <span class='nx'>foo</span><span class='o'>:</span> <span class='mi'>1</span> <span class='p'>};</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>hash</span><span class='p'>(</span><span class='nx'>obj</span><span class='p'>)</span> <span class='o'>===</span> <span class='mi'>1</span> <span class='p'>);</span>
</code></pre></div>
<p>It seems that Mori has a monotonically increasing counter for object hash values. The first object that it computes a hash for gets the value <code>1</code>; the second object gets <code>2</code>, and so on. To keep track of which object got which hash value, it stores the value on the object itself:</p>
<div class='highlight'><pre><code class='js'><span class='nb'>Object</span><span class='p'>.</span><span class='nx'>keys</span><span class='p'>(</span><span class='nx'>obj</span><span class='p'>);</span>
<span class='c1'>//&gt; [ &#39;foo&#39;, &#39;closure_uid_335348264&#39; ]</span>
<span class='nx'>obj</span><span class='p'>.</span><span class='nx'>closure_uid_335348264</span><span class='p'>;</span>
<span class='c1'>//&gt; 1</span>
</code></pre></div>
<p>There are obvious hash-collision issues between non-Mori objects, numbers, and <code>true</code>. But Mori data structures can handle hash collisions. If a collection uses all of those types as keys it could end up with one hash bucket with three entries.</p>

<h3 id='equals'>equals</h3>

<p>Mori has its own equals function, which also comes from ClojureScript. As with hash, any two mori values that have the same content are considered to be equal:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>equals</span><span class='p'>(</span><span class='nx'>v</span><span class='p'>,</span> <span class='nx'>v2</span><span class='p'>)</span> <span class='p'>);</span>
</code></pre></div>
<p>It works on primitive JavaScript values:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>equals</span><span class='p'>(</span><span class='mi'>2</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>)</span> <span class='p'>);</span>
</code></pre></div>
<p>When applied to non-Mori JavaScript objects, <code>equals</code> works the same way that the built-in <code>===</code> function does:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>obj_1</span> <span class='o'>=</span> <span class='p'>{</span> <span class='nx'>bar</span><span class='o'>:</span> <span class='mi'>1</span> <span class='p'>};</span>
<span class='kd'>var</span> <span class='nx'>obj_2</span> <span class='o'>=</span> <span class='p'>{</span> <span class='nx'>bar</span><span class='o'>:</span> <span class='mi'>1</span> <span class='p'>};</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='o'>!</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>equals</span><span class='p'>(</span><span class='nx'>obj_1</span><span class='p'>,</span> <span class='nx'>obj_2</span><span class='p'>)</span> <span class='p'>);</span>
<span class='nx'>assert</span><span class='p'>(</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>equals</span><span class='p'>(</span><span class='nx'>obj_1</span><span class='p'>,</span> <span class='nx'>obj_1</span><span class='p'>)</span> <span class='p'>);</span>
</code></pre></div>
<h3 id='compare'>compare</h3>

<p>ClojureScript has a compare function, which Mori uses in its sorted data structure implementations. Mori does not export the compare function. The function defines an ordering for Mori values and for primitive JavaScript values - but not for other JavaScript objects. So if you want to put non-Mori objects into a sorted structure you will have to use an implementation that accepts a custom comparison function.</p>

<h2 id='different_map_and_set_implementations'>Different map and set implementations</h2>

<p><code>hash_map</code> and <code>set</code> use a hash function for lookups and have O(log_32 n) lookup times; the sorted variants use comparison functions for lookups and have O(log_2 n) lookup times; and <code>array_map</code> is just an array of key-value pairs, so it uses only an equality function for lookups and has O(n) lookup times.</p>
<table><thead><tr><th>constructor</th><th>insert time</th><th>lookup time</th><th>how keys/values are checked</th></tr></thead><tbody><tr><td style='text-align: left;'><code>hash_map</code></td><td style='text-align: right;'>log_32&#160;n</td><td style='text-align: right;'>log_32&#160;n</td><td style='text-align: left;'><code>hash(key) === hash(target_key) &amp;&amp; equals(key, target_key)</code></td>
</tr><tr><td style='text-align: left;'><code>array_map</code></td><td style='text-align: right;'>1</td><td style='text-align: right;'>n</td><td style='text-align: left;'><code>equals(key, target_key)</code></td>
</tr><tr><td style='text-align: left;'><code>sorted_map</code></td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: left;'><code>compare(key, target_key)</code></td>
</tr><tr><td style='text-align: left;'><code>sorted_map_by</code></td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: left;'>like <code>sorted_map</code> with a user-supplied comparison function</td>
</tr><tr><td style='text-align: left;'><code>set</code></td><td style='text-align: right;'>log_32&#160;n</td><td style='text-align: right;'>log_32&#160;n</td><td style='text-align: left;'><code>hash(val) === hash(target_val) &amp;&amp; equals(val, target_val)</code></td>
</tr><tr><td style='text-align: left;'><code>sorted_set</code></td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: left;'><code>compare(val, target_val)</code></td>
</tr><tr><td style='text-align: left;'><code>sorted_set_by</code></td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: right;'>log_2&#160;n</td><td style='text-align: left;'>like <code>sorted_set</code> with a user-supplied comparison function</td>
</tr></tbody></table>
<p><code>hash</code> and <code>equals</code> are provided by Mori. <code>compare</code> is part of ClojureScript, but is not exported by Mori.</p>

<p>Note that the sorted structures do not perform <code>equals</code> checks - instead they rely on a comparison function to determine whether values or keys are the same. On the other hand, the hash structures do perform <code>equals</code> checks to handle hash collisions.</p>

<p><code>array_map</code> is unique among the map and set implementations in that it preserves the order of keys and values based on the order in which they were inserted. If a value is inserted into an <code>array_map</code> and then the map is converted to a sequence (for example, using <code>mori.seq(m)</code>) then the last key-value pair inserted appears last in the resulting sequence. The ordering in a new <code>array_map</code> is determined by the order of key-value pairs given to the constructor.</p>

<p><code>array_map</code> is a good choice for small maps that are accessed frequently. The linear lookup time looks slower than other map implementations on paper. But there is no hashing involved and only simple vector traversal - so each of those n steps is faster than each of the log_32 n steps in a <code>hash_map</code> lookup.</p>

<p>The <code>array_map</code> implementation has an internal notion of the upper limit on an efficient size. Once the map reaches that threshold, inserting another key-value pair produces a <code>hash_map</code> instead of a larger <code>array_map</code>.<sup id='fnref:4'><a href='#fn:4' rel='footnote'>4</a></sup></p>

<p>The information here on implementations and running times mainly comes from <a href='http://www.infoq.com/articles/in-depth-look-clojure-collections'>An In-Depth Look at Clojure Collections</a>.</p>

<h2 id='laziness'>Laziness</h2>

<p>Many of the functions provided by Mori return what is called a lazy sequence. Being a sequence this is like a list and can be transformed using functions like <code>map</code>, <code>filter</code>, and <code>reduce</code>. What makes a sequence lazy is that it is not actually computed right away. Evaluation is deferred until some non-lazy function accesses one or more elements of the transformed sequence. At that point Mori computes and memoizes transformations.</p>
<div class='highlight'><pre><code class='js'><span class='c1'>// Sets, maps, vectors, and lists are actually not lazy.  But ranges</span>
<span class='c1'>// are.</span>
<span class='kd'>var</span> <span class='nx'>s</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sorted_set_by</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>,</span> <span class='nx'>b</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='s1'>&#39;comparing&#39;</span><span class='p'>,</span> <span class='nx'>a</span><span class='p'>,</span> <span class='nx'>b</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='nx'>a</span> <span class='o'>-</span> <span class='nx'>b</span><span class='p'>;</span>
<span class='p'>},</span> <span class='mi'>5</span><span class='p'>,</span> <span class='mi'>4</span><span class='p'>,</span> <span class='mi'>3</span><span class='p'>,</span> <span class='mi'>2</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>);</span>

<span class='c1'>// Outputs approximately n * log_2(n) lines:</span>
<span class='c1'>// &gt; comparing 4 5</span>
<span class='c1'>// &gt; comparing 3 5</span>
<span class='c1'>// &gt; comparing 3 4</span>
<span class='c1'>// &gt; comparing 2 4</span>
<span class='c1'>// &gt; comparing 2 3</span>
<span class='c1'>// &gt; comparing 1 4</span>
<span class='c1'>// &gt; comparing 1 3</span>
<span class='c1'>// &gt; comparing 1 2</span>

<span class='c1'>// `map` returns a lazy sequence of transformed values.</span>
<span class='kd'>var</span> <span class='nx'>seq</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='s1'>&#39;processed:&#39;</span><span class='p'>,</span> <span class='nx'>e</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='mi'>0</span> <span class='o'>-</span> <span class='nx'>e</span><span class='p'>;</span>
<span class='p'>},</span> <span class='nx'>s</span><span class='p'>);</span>

<span class='c1'>// No output yet.</span>

<span class='c1'>// Getting the string representation of a collection or applying a</span>
<span class='c1'>// non-lazy function like `reduce` forces evaluation.</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>seq</span><span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; processed: 1</span>
<span class='c1'>// &gt; processed: 2</span>
<span class='c1'>// &gt; processed: 3</span>
<span class='c1'>// &gt; processed: 4</span>
<span class='c1'>// &gt; processed: 5</span>
<span class='c1'>// &gt; (-1 -2 -3 -4 -5)</span>
</code></pre></div>
<p>The results of a lazy evaluation are cached. If the same sequence is forced again the map function will not be called a second time:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>seq</span><span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; (-1 -2 -3 -4 -5)</span>
</code></pre></div>
<p>Mori runs just enough deferred computation to get whatever result is needed. It is often not necessary to compute an entire lazy sequence:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>seq_</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='s1'>&#39;processed:&#39;</span><span class='p'>,</span> <span class='nx'>e</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='nx'>e</span> <span class='o'>*</span> <span class='mi'>2</span><span class='p'>;</span>
<span class='p'>},</span> <span class='nx'>s</span><span class='p'>);</span>

<span class='c1'>// `take` returns a lazy sequence of the first n members of a</span>
<span class='c1'>// collection.</span>
<span class='kd'>var</span> <span class='nx'>seq__</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>take</span><span class='p'>(</span><span class='mi'>2</span><span class='p'>,</span> <span class='nx'>seq_</span><span class='p'>);</span>

<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>seq__</span><span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; processed: 1</span>
<span class='c1'>// &gt; processed: 2</span>
<span class='c1'>// &gt; (2 4)</span>
</code></pre></div>
<p>In the above case there is an intermediate lazy sequence that theoretically contains five values: the results of doubling values in the original set. But only the first two values in that sequence are needed. The other three are never computed.</p>

<p>Laziness means that it is possible to create infinite sequences without needing unlimited memory or time:</p>
<div class='highlight'><pre><code class='js'><span class='c1'>// With no arguments, `range` returns a lazy sequence of all whole</span>
<span class='c1'>// numbers from zero up.</span>
<span class='kd'>var</span> <span class='nx'>non_neg_ints</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>range</span><span class='p'>();</span>

<span class='c1'>// Dropping the first element, zero, results in a sequence of all of</span>
<span class='c1'>// the natural numbers.</span>
<span class='kd'>var</span> <span class='nx'>nats</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>drop</span><span class='p'>(</span><span class='mi'>1</span><span class='p'>,</span> <span class='nx'>non_neg_ints</span><span class='p'>);</span>

<span class='c1'>// Let&#39;s take just the powers of 2.</span>
<span class='kd'>var</span> <span class='nx'>log_2</span>    <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='o'>/</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>LN2</span><span class='p'>;</span> <span class='p'>};</span>
<span class='kd'>var</span> <span class='nx'>is_pow_2</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='p'>{</span> <span class='k'>return</span> <span class='nx'>log_2</span><span class='p'>(</span><span class='nx'>n</span><span class='p'>)</span> <span class='o'>%</span> <span class='mi'>1</span> <span class='o'>===</span> <span class='mi'>0</span><span class='p'>;</span> <span class='p'>};</span>
<span class='kd'>var</span> <span class='nx'>pows_2</span>   <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>filter</span><span class='p'>(</span><span class='nx'>is_pow_2</span><span class='p'>,</span> <span class='nx'>nats</span><span class='p'>);</span>

<span class='c1'>// What are the first 10 powers of 2?</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>take</span><span class='p'>(</span><span class='mi'>10</span><span class='p'>,</span> <span class='nx'>pows_2</span><span class='p'>)</span>
<span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; (1 2 4 8 16 32 64 128 256 512)</span>

<span class='c1'>// What is the 20th power of 2?</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>nth</span><span class='p'>(</span><span class='nx'>pows_2</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>)</span>
<span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; 1048576</span>
</code></pre></div>
<p>If you try this out in a REPL, such as node, be aware that when an expression is entered a JavaScript REPL will usually try to print the value of that expression, which has the effect of forcing evaluation of lazy sequences. If you enter a lazy sequence you will end up in an infinite loop:</p>
<div class='highlight'><pre><code class='js'><span class='nx'>non_neg_ints</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>range</span><span class='p'>();</span>

<span class='c1'>// Loops for a long time, then runs out of memory.</span>
</code></pre></div>
<p>The solution to this is to be careful to assign infinite sequences in <code>var</code> statements. That prevents the REPL from trying to print the sequence:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>non_neg_ints</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>range</span><span class='p'>();</span>

<span class='c1'>// Prints &#39;undefined&#39;, all is well.</span>
</code></pre></div>
<p>Powers of two are actually a terrible example of a lazy sequence: any element in that sequence could be calculated more quickly using <code>Math.pow()</code>. It just happens that powers of two are simple to demonstrate.</p>

<p>Algorithms that really do benefit from infinite sequences are those where computation of any element requires references to earlier values in the sequence. A good example is computing <a href='https://en.wikipedia.org/wiki/Fibonacci_number'>Fibonacci numbers</a>.</p>
<div class='highlight'><pre><code class='js'><span class='kd'>function</span> <span class='nx'>fibs</span><span class='p'>()</span> <span class='p'>{</span>
    <span class='kd'>var</span> <span class='nx'>pairs</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>iterate</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>pair</span><span class='p'>)</span> <span class='p'>{</span>
        <span class='kd'>var</span> <span class='nx'>x</span> <span class='o'>=</span> <span class='nx'>pair</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>],</span> <span class='nx'>y</span> <span class='o'>=</span> <span class='nx'>pair</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>];</span>
        <span class='k'>return</span> <span class='p'>[</span><span class='nx'>y</span><span class='p'>,</span> <span class='nx'>x</span> <span class='o'>+</span> <span class='nx'>y</span><span class='p'>];</span>
    <span class='p'>},</span> <span class='p'>[</span><span class='mi'>0</span><span class='p'>,</span> <span class='mi'>1</span><span class='p'>]);</span>
    <span class='k'>return</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>first</span><span class='p'>,</span> <span class='nx'>pairs</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre></div>
<p>This implementation uses the <a href='http://swannodette.github.io/mori/#iterate'><code>iterate</code></a> function, which takes a function and an initial value. It creates an infinite sequence by repeatedly applying the given function. The given starting value is <code>[0, 1]</code>, and each invocation of the given function combines the second value in the previous pair with the sum of the values in the previous pair; so the resulting sequence is: <code>([0, 1] [1, 1] [1, 2] [2, 3] [3, 5]
...)</code>. The <a href='http://swannodette.github.io/mori/#map'><code>map</code></a> function is applied to that, taking the first value from each pair.</p>

<p>Using this sequence allows us to ask the questions:</p>
<div class='highlight'><pre><code class='js'><span class='c1'>// What are the first ten values in the Fibonacci sequence?</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>take</span><span class='p'>(</span><span class='mi'>10</span><span class='p'>,</span> <span class='nx'>fibs</span><span class='p'>())</span>
<span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; (0 1 1 2 3 5 8 13 21 34)</span>

<span class='c1'>// What is the 100th number in the Fibonacci sequence?</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>nth</span><span class='p'>(</span><span class='nx'>fibs</span><span class='p'>(),</span> <span class='mi'>100</span><span class='p'>)</span>
<span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; 354224848179262000000</span>

<span class='c1'>// What is the sum of the first 4 Fibonacci numbers that are also</span>
<span class='c1'>// powers of 2?</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>reduce</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>sum</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>,</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>take</span><span class='p'>(</span><span class='mi'>4</span><span class='p'>,</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>filter</span><span class='p'>(</span><span class='nx'>is_pow_2</span><span class='p'>,</span> <span class='nx'>fibs</span><span class='p'>())))</span>
<span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; 12</span>

<span class='c1'>// What is the 5th Fibonacci number that is also a power of 2?</span>
<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>nth</span><span class='p'>(</span><span class='nx'>mori</span><span class='p'>.</span><span class='nx'>filter</span><span class='p'>(</span><span class='nx'>is_pow_2</span><span class='p'>,</span> <span class='nx'>fibs</span><span class='p'>()),</span> <span class='mi'>4</span><span class='p'>)</span>
<span class='p'>);</span>

<span class='c1'>// My computer runs for a long time with no apparent answer...</span>
</code></pre></div>
<p>A lazy sequence might also contain lines from a large file or chunks of data flowing into a network server. At the time of this writing I was not able to write a program that traversed a long sequence in constant space. But I have verified that this is possible in JavaScript. I may find a solution and post an update later.</p>

<h3 id='efficiency'>Efficiency</h3>

<p>In procedural code running a sequence through multiple operations that apply to every element would result in multiple iterations of the entire sequence. Because Mori operates lazily it can potentially collect transformations for each element and apply them in a single pass:</p>
<div class='highlight'><pre><code class='js'><span class='kd'>var</span> <span class='nx'>seq_1</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='s1'>&#39;first pass:&#39;</span><span class='p'>,</span> <span class='nx'>e</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='nx'>e</span><span class='p'>;</span>
<span class='p'>},</span> <span class='nx'>s</span><span class='p'>);</span>
<span class='kd'>var</span> <span class='nx'>seq_2</span> <span class='o'>=</span> <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>map</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>(</span><span class='nx'>e</span><span class='p'>)</span> <span class='p'>{</span>
    <span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span><span class='s1'>&#39;second pass:&#39;</span><span class='p'>,</span> <span class='nx'>e</span><span class='p'>);</span>
    <span class='k'>return</span> <span class='nx'>e</span><span class='p'>;</span>
<span class='p'>},</span> <span class='nx'>seq_1</span><span class='p'>);</span>

<span class='nx'>console</span><span class='p'>.</span><span class='nx'>log</span><span class='p'>(</span>
    <span class='nx'>mori</span><span class='p'>.</span><span class='nx'>take</span><span class='p'>(</span><span class='mi'>2</span><span class='p'>,</span> <span class='nx'>seq_2</span><span class='p'>);</span>
<span class='p'>);</span>

<span class='c1'>// Outputs:</span>
<span class='c1'>// &gt; first pass: 1</span>
<span class='c1'>// &gt; second pass: 1</span>
<span class='c1'>// &gt; first pass: 2</span>
<span class='c1'>// &gt; second pass: 2</span>
<span class='c1'>// &gt; (1 2)</span>
</code></pre></div>
<p>If applying <code>map</code> to a collection twice resulted in two iterations we would expect to see:</p>
<div class='highlight'><pre><code class='js'><span class='c1'>// &gt; first pass: 1</span>
<span class='c1'>// &gt; first pass: 2</span>
<span class='c1'>// &gt; second pass: 1</span>
<span class='c1'>// &gt; second pass: 2</span>
</code></pre></div>
<p>The fact that the first pass and second pass are interleaved suggests that Mori collects transformations and applies all transformations to a value at once. This is the advantage of lazy evaluation: it encourages writing code in a way that makes most logical sense rather than thinking about performance. You can write what are logically many iterations over a collection and the library will rearrange computations to minimize the actual work that is done.</p>
<div class='footnotes'><hr /><ol><li id='fn:1'>
<p>You might be wondering how Clojure handles polymorphism, since the convention is to use functions instead of methods. Clojure has a feature called <a href='http://clojure.org/protocols'>protocols</a> that permit multiple implementations for functions depending on the type of a given argument. Elsewhere in the functional world, <a href='http://www.haskell.org/haskellwiki/Haskell'>Haskell</a> and <a href='http://www.scala-lang.org/'>Scala</a> provide a similar, yet more powerful feature, called <a href='http://learnyouahaskell.com/types-and-typeclasses'>type classes</a>.</p>
<a href='#fnref:1' rev='footnote'>&#8617;</a></li><li id='fn:2'>
<p>When <code>conj</code> is used on a list it prepends elements (like <code>cons</code>) because prepending is much cheaper than inserting at other possible positions. Given a vector <code>conj</code> appends values. Appending is often desired, and appending to a vector is just as efficient as inserting at any other position. <code>conj</code> works on sets and maps too - but in those cases the idea of insertion position is not usually meaningful.</p>
<a href='#fnref:2' rev='footnote'>&#8617;</a></li><li id='fn:3'>
<p>It does look like ECMAScript 6 will add <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map'>a Map implementation</a> and a <a href='https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/WeakMap'>WeakMap</a> to the language spec, both of which will take arbitrary objects as keys (only non-primitives in the WeakMap case). But those implementations will not be immutable!</p>
<a href='#fnref:3' rev='footnote'>&#8617;</a></li><li id='fn:4'>
<p><a href='http://clojure.org/data_structures#Data%20Structures-ArrayMaps'>http://clojure.org/data_structures#Data Structures-ArrayMaps</a></p>
<a href='#fnref:4' rev='footnote'>&#8617;</a></li></ol></div></div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2013/11/04/functional-data-structures.html">Functional data structures in JavaScript with Mori</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/22/functional-reactive-programming-in-javascript.html">Functional Reactive Programming in JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/2012/09/04/monkey-patching-document-write.html">Monkey patching document.write()</a>
      </li>
    
      <li class="post">
        <a href="/2012/07/31/promise-pipelines-in-javascript.html">Promise Pipelines in JavaScript</a>
      </li>
    
      <li class="post">
        <a href="/2012/05/12/installing-a-custom-rom-on-the-transformer-prime.html">Installing a custom ROM on the Transformer Prime: A start-to-finish guide</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Talks</h1>
  <ul id="talks">
    <li><a href="http://opensourcebridge.org/sessions/1067">Mod your Android</a></li>
    <li><a href="talks/intro-to-javascript/">Introduction to JavaScript</a></li>
    <li><a href="http://lanyrd.com/2012/nodepdx/smyqm/">Object-oriented patterns in JavaScript</a></li>
    <li><a href="talks/cookies/">Cookies are bad for you</a></li>
    <li><a href="talks/professional-javascript/">Professional JavaScript</a></li>
    <li><a href="http://opensourcebridge.org/2009/wiki/Clustering_Data_--_How_to_Have_Fun_in_n-Dimensions">Cluster Analysis: How to Have Fun in n Dimensions</a></li>
    <li><a href="https://docs.google.com/presentation/d/1hx9Pzo07aAnZ2skMH4JPjH7a6IXx64uC0zRliS3qpkk/edit?usp=sharing">How to build blazing fast web apps with Ruby on Rails</a></li>
  </ul>
</section>
<section>
  <h1>Open Source Projects</h1>
  <ul id="projects">
    <li><a href="http://github.com/jivesoftware/tAMD">tAMD:</a> Tiny, extensible implementation of the Asynchronous Module Definition (AMD) specification from CommonJS</li>
  </ul>
</section>
<section>
  <div class="contact" style="float:left; margin:0.5em;">
    <p>
      Jesse Hallett<br/>
      <a href="mailto:jesse@sitr.us">jesse@sitr.us</a>
    </p>
  </div>
  <div class="contact" style="float:left; margin:0.5em;">
    <p>
      <a href="http://github.com/hallettj/">github.com/hallettj</a><br />
      <a href="http://twitter.com/hallettj/">twitter.com/hallettj</a>
    </p>
  </div>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Jesse Hallett -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hallettj';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
