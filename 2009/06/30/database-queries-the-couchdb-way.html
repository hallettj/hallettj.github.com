
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Database Queries the CouchDB Way - sitr.us</title>
  <meta name="author" content="Jesse Hallett">

  
  <meta name="description" content="CouchDB is a document-oriented database. It has no rows or tables. Instead
CouchDB is a collection of JSON documents. It uses a map-reduce pattern to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- OpenID delegation -->
  <link rel="openid.delegate" href="http://sitr.us/" />
  <link rel="openid.server" href="https://indieauth.com/openid" />

  
  <link rel="canonical" href="http://sitr.us/2009/06/30/database-queries-the-couchdb-way.html">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/hallettj" rel="alternate" title="sitr.us" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Ubuntu+Mono:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-327628-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">sitr.us</a></h1>
  
    <h2>posts by Jesse Hallett</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/hallettj" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:sitr.us" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Database Queries the CouchDB Way</h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-06-30T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p><a href="http://couchdb.apache.org/">CouchDB</a> is a document-oriented database. It has no rows or tables. Instead
CouchDB is a collection of JSON documents. It uses a map-reduce pattern to
index data. Queries in CouchDB pull data from what are essentially stored
procedures called views. A view is made up of a map function and optionally a
reduce function.  Ninety percent of the time all you need is the map function,
so I will focus on map-only views here.</p>

<p>A map function is a JavaScript function that takes a single document as an
argument and emits any number of key/value pairs. Both the key and the value
can be any JSON value you choose. The map function is run on every document in
the database individually and the emitted key/value pairs are used to construct
an index of your data.</p>

<h2 id="a-simple-example">A Simple Example</h2>

<p>Imagine you have a database with user records and you want a view of those
records using the last name of each user as keys.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">last_name</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">last_name</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>The above map function will produce and index something like the one below.
Because <code>doc</code> is used as a value for each entry the entire content of each JSON
document will be accessible as the indexed values.</p>

<div class="highlight"><pre><code class="js"><span class="p">[</span>
  <span class="p">...</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Clarke&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">last_name</span><span class="o">:</span> <span class="s2">&quot;Clarke&quot;</span><span class="p">,</span> <span class="p">...</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Kelly&quot;</span><span class="p">,</span>  <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">last_name</span><span class="o">:</span> <span class="s2">&quot;Kelly&quot;</span><span class="p">,</span>  <span class="p">...</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>  <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">last_name</span><span class="o">:</span> <span class="s2">&quot;Smith&quot;</span><span class="p">,</span>  <span class="p">...</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">...</span>
<span class="p">]</span>
</code></pre></div>

<p>Notice that the map function checks each document for a <code>last_name</code> attribute
before emitting a key/value pair. There may be documents in the database that
are not user records. By performing that check the view excludes any
non-user-record documents from the resulting index.</p>

<!-- more -->

<p>If you include the <a href="http://github.com/halorgium/couchdb/blob/2c5f780d8284be5e2cb39f7f61acc5ef8d6fb50d/share/www/script/couch.js">couch.js</a> library in a web page you can create
client-side queries to pull data from CouchDB over HTTP.  The function below
will fetch all of the user records from your database by returning the <code>value</code>
of each key/value pair emitted by the view above.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">users</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;users/last_names&#39;</span><span class="p">).</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// Run the query and output data to the console.</span>
<span class="kd">var</span> <span class="nx">db</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CouchDB</span><span class="p">(</span><span class="s1">&#39;database-with-users&#39;</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">users</span><span class="p">(</span><span class="nx">db</span><span class="p">));</span>
</code></pre></div>

<p>Map functions operate on one document at a time and cannot access data from
other documents. The advantage of this is that the functions can process data
in any order and can run on any piece of a data set independent of the rest of
the set.  CouchDB builds static indexes from the output of view map functions
so that queries against those views will run quickly.  When any documents
change CouchDB can incrementally rebuild the indexes for just those documents
without having to rebuild entire indexes from scratch.</p>

<p>The CouchDB design gets you great performance on large data sets. But it means
that you cannot pass dynamic parameters to your map function when you run a
query. You cannot ask for it to emit only user records with a given last name
unless you want to maintain a special view for that particular last name. In
most cases it is not practical to build separate views for every query that you
might want to run someday. So what you can do is to run a query against the
general purpose view above and request only key/value pairs that match a
particular key.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">find_users_by_last_name</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">last_name</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">matches</span><span class="p">;</span>
    <span class="nx">matches</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;users/last_names&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">last_name</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p>This client code creates a query that requests data from the <code>last_names</code> view
with a <code>key</code> parameter. CouchDB will only send back key/value pairs with keys
that match the <code>key</code> parameter. In this case the query will return all user
records with last names matching the <code>last_name</code> argument.</p>

<p>In a more advanced case you may want to take the first few letters of a last
name and look up user records that match.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">find_users_whose_last_names_start_with</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">matches</span><span class="p">;</span>
    <span class="nx">matches</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;users/last_names&#39;</span><span class="p">,</span>
                      <span class="p">{</span> <span class="nx">startkey</span><span class="o">:</span> <span class="nx">query</span><span class="p">,</span>
                        <span class="nx">endkey</span><span class="o">:</span>   <span class="nx">query</span> <span class="o">+</span> <span class="s2">&quot;\u9999&quot;</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p>Data returned by a query is always sorted by key. In the case where the keys
are strings the sorting will be lexicographic.  The <code>startkey</code> and <code>endkey</code>
parameters restrict the results of the query to key/value pairs that fall in
the given range according to CouchDB’s sort order.</p>

<p>When the above function is given the query string “Ha”, it will fetch documents
with keys sorted after “Ha” lexicographically, e.g. “Hallett”, “Hathaway”, and
“Hazzold”. The <code>endkey</code> is created by appending “\u9999” to the <code>startkey</code>.
“\u9999” is a unicode character that comes after most other characters in
lexicographic order and that is unlikely to appear in a data set. Effectively
the string “Ha\u9999” sorts after every other string that begins with “Ha”, but
before any string that starts with “Hb”.</p>

<p>Note that CouchDB uses the <a href="http://www.unicode.org/unicode/reports/tr10/">Unicode Collation Algorithm</a> to sort strings.
Sorting comes out differently than you may be used to if your are accustomed to
the ASCII way. UCA collation is intended to mimic the order of strings you
would see in a dictionary. For example, two strings that differ only in case
will appear together in sorted order. The lower-case string will appear
immediately before the upper-case string. So if you force your <code>startkey</code> to
lower-case and your <code>endkey</code> to upper-case you will get case-insensitive
matches. See the <a href="http://wiki.apache.org/couchdb/View_collation">CouchDB wiki</a> for more details.</p>

<h2 id="search-by-keyword">Search by Keyword</h2>

<p>Indexing text content can be a hard problem because you need a large index if
you want to query data by arbitrary keywords or substrings.  Fortunately
CouchDB excels at managing large indexes.</p>

<p>Here is a map function that creates an index of all the words that appear in
the text field of every document in a database.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tokens</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tokens</span> <span class="o">=</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/[^A-Z0-9\-_]+/i</span><span class="p">).</span><span class="nx">uniq</span><span class="p">();</span>
        <span class="nx">tokens</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emit</span><span class="p">(</span><span class="nx">token</span><span class="p">,</span> <span class="nx">doc</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>The code splits text on word boundaries stripping out non-alphanumeric
characters. It runs the resulting list of tokens through a unique filter so
that only one index key is produced for each word in the text of a single
document.</p>

<p>This is an example of a view that emits more than one key/value pair for each
document. The values in each pair are the same for the same document. But a
different key is recorded for each word in the document’s text attribute. The
index that would be created by this view for a document with the text “Live
long and prosper” is below.</p>

<div class="highlight"><pre><code class="js"><span class="p">[</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;and&quot;</span><span class="p">,</span>     <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Live long and prosper.&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Live&quot;</span><span class="p">,</span>    <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Live long and prosper.&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;long&quot;</span><span class="p">,</span>    <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Live long and prosper.&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;prosper&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Live long and prosper.&quot;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>To look up documents that contain a given keyword you just need to create a
query with that keyword as the <code>key</code> parameter. But what if you want to look
for documents that contain a list of keywords? You could create index keys for
every combination of words in each document. But that index would grow
exponentially and might get to be unreasonably large. A better way might be to
pick one keyword to perform your query and then to use client code to select
the documents that match all of the keywords out of the results returned by
CouchDB.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">find_documents_by_keywords</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">keywords</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">possible_matches</span><span class="p">;</span>

    <span class="c1">// Query documents that include the first keyword.</span>
    <span class="nx">possible_matches</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;documents/keywords&#39;</span><span class="p">,</span> 
                               <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="nx">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">});</span>

    <span class="c1">// Pull the value attribute out of each returned key/value</span>
    <span class="c1">// pair.</span>
    <span class="nx">possible_matches</span> <span class="o">=</span> <span class="nx">possible_matches</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">));</span>

    <span class="c1">// Pick out the documents that include all of the given</span>
    <span class="c1">// keywords.</span>
    <span class="k">return</span> <span class="nx">possible_matches</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">m</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">keywords</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">match</span><span class="p">,</span> <span class="nx">keyword</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">keyword</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">match</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>When you want more dynamic data processing than you can get with pure-CouchDB
views, some client-side processing can make up the difference nicely. From a
perspective of deploying applications leveraging your users’ CPU cycles for
data processing can really help getting your application to scale.</p>

<p>There is another approach to full text search documented <a href="http://wiki.apache.org/couchdb/Full_text_index_with_view">on the CouchDB
wiki</a>.</p>

<h2 id="search-by-substring">Search by Substring</h2>

<p>Maybe keyword search isn’t good enough. Maybe you need to be able to search for
occurrences of any substring in a data set.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">emit</span><span class="p">(</span><span class="nx">doc</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="p">),</span> <span class="nx">doc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>For each document, this map function emits a key/value pair for every possible
substring that runs to the end of the document’s text. The idea is that the
beginning of any substring in the data set can be lined up with the beginning
of one of these keys.  Here is an example of the index created for a document
with the text “Hello, world!”:</p>

<div class="highlight"><pre><code class="js"><span class="p">[</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot; world!&quot;</span><span class="p">,</span>       <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;, world!&quot;</span><span class="p">,</span>      <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;!&quot;</span><span class="p">,</span>             <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;d!&quot;</span><span class="p">,</span>            <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;ello, world!&quot;</span><span class="p">,</span>  <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span><span class="p">,</span> <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;ld!&quot;</span><span class="p">,</span>           <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;llo, world!&quot;</span><span class="p">,</span>   <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;lo, world!&quot;</span><span class="p">,</span>    <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;o, world!&quot;</span><span class="p">,</span>     <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;orld!&quot;</span><span class="p">,</span>         <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;rld!&quot;</span><span class="p">,</span>          <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="nx">key</span><span class="o">:</span> <span class="s2">&quot;world!&quot;</span><span class="p">,</span>        <span class="nx">value</span><span class="o">:</span> <span class="p">{</span> <span class="nx">text</span><span class="o">:</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]</span>
</code></pre></div>

<p>The substring that you want to search for can begin at any character within
some document’s text. It may or may not run until the end of that document’s
text field. We have an index with the beginning characters for every possible
substring. So we can create a query that asks for a key range that encompasses
both the given substring and a substring that runs all the way to the end of
the document text.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">find_all_by_substring</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;documents/substrings&#39;</span><span class="p">,</span>
                   <span class="p">{</span> <span class="nx">startkey</span><span class="o">:</span> <span class="nx">str</span><span class="p">,</span>
                     <span class="nx">endkey</span><span class="o">:</span> <span class="nx">str</span> <span class="o">+</span> <span class="s2">&quot;\u9999&quot;</span> <span class="p">}</span>
                  <span class="p">).</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div>

<p>CouchDB does not just sort data when responding to queries. In its internal
representation indexes are always sorted by key.  So a query with a key range
targets a contiguous block of data from the database.  Because of that CouchDB
can serve up a key range very efficiently.</p>

<p>Just as with the keyword search, if you want to search for documents that match
a list of substrings then get the matches for one of the substrings from
CouchDB and use client code to select results that contain all of the rest of
the given substrings.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">find_all_by_substrings</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">strs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">matches</span><span class="p">;</span>
    <span class="nx">matches</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;documents/substrings&#39;</span><span class="p">,</span>
                      <span class="p">{</span> <span class="nx">startkey</span><span class="o">:</span> <span class="nx">strs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="nx">endkey</span><span class="o">:</span> <span class="nx">strs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;\u9999&quot;</span> <span class="p">});</span>
    <span class="k">return</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)).</span><span class="nx">select</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">strs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">text</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">r</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

<p>If the text of your documents tends to be very long you can avoid a lot of
really long keys by limiting the lengths of substring keys in your view. In
that case make sure to truncate the key parameters in your queries so that they
are not longer than the index keys.</p>

<p><em>Updated 2009-07-05</em>: Updated examples to demonstrate that CouchDB stores
indexes sorted by key. Thanks to J. Chris Anderson for pointing that out.<br />
<em>Updated 2009-08-06</em>: Added link to full text search implementation on
CouchDB wiki.<br />
<em>Updated 2009-08-09</em>: Fixed a typo.  </p>

<h2 id="appendix-helper-function-definitions">Appendix: Helper Function Definitions</h2>

<p>Some of the functions that I used in the examples above are not built into
JavaScript or <a href="http://github.com/halorgium/couchdb/blob/2c5f780d8284be5e2cb39f7f61acc5ef8d6fb50d/share/www/script/couch.js">couch.js</a>. Here are definitions of those functions for
reference.</p>

<p>Given an attribute name, <code>dot</code> returns a function that when given an object
returns the value of the specified attribute. This function is used in examples
above to get the <code>value</code> attributes of rows fetched by CouchDB queries.</p>

<div class="highlight"><pre><code class="js"><span class="kd">function</span> <span class="nx">dot</span><span class="p">(</span><span class="nx">attr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">attr</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><a href="http://en.wikipedia.org/wiki/Map_%28higher-order_function%29"><code>map</code></a> is an Array method that given a function that takes a single
argument returns a new array formed by applying the given function to every
element of the original array in turn.</p>

<div class="highlight"><pre><code class="js"><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">map</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">r</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">r</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">func</span><span class="p">(</span><span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>

<p><a href="http://en.wikipedia.org/wiki/Reduce_%28higher-order_function%29"><code>reduce</code></a> is an Array method that given an initial value and a
function that takes two arguments returns a single value produced by applying
the given function to every element of the array in turn with the value from
the previous function invocation and returning the last result.</p>

<div class="highlight"><pre><code class="js"><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">reduce</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">val</span> <span class="o">=</span> <span class="nx">func</span><span class="p">(</span><span class="nx">val</span><span class="p">,</span> <span class="k">this</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">val</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><code>select</code> is an Array method that given a test function returns a new array made
up of only elements in the original array that pass the test.</p>

<div class="highlight"><pre><code class="js"><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">select</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">test</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">test</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">r</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">e</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">r</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">};</span>
</code></pre></div>

<p><code>uniq</code> is an Array method that returns a new array with any duplicate values
from the original array removed.</p>

<div class="highlight"><pre><code class="js"><span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">uniq</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">reduce</span><span class="p">([],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">list</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">list</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">list</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="nx">e</span><span class="p">]);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">list</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Jesse Hallett</span></span>

      








  


<time datetime="2009-06-30T00:00:00-04:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/2008/07/29/how-to-use-rspec-to-describe-a-sinatra-application.html" title="Previous Post: How to use RSpec to describe a Sinatra application">&laquo; How to use RSpec to describe a Sinatra application</a>
      
      
        <a class="basic-alignment right" href="/2009/07/02/how-to-install-haskell-platform-on-ubuntu-jaunty.html" title="Next Post: How to install Haskell "Batteries Included" Platform on Ubuntu Jaunty">How to install Haskell "Batteries Included" Platform on Ubuntu Jaunty &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2017/02/21/changes-i-would-make-to-go.html">Changes I would make to Go</a>
      </li>
    
      <li class="post">
        <a href="/2017/01/03/flow-cookbook-react.html">Flow Cookbook: Flow & React</a>
      </li>
    
      <li class="post">
        <a href="/2016/12/20/flow-cookbook-unpacking-json.html">Flow Cookbook: Unpacking JSON API data</a>
      </li>
    
      <li class="post">
        <a href="/2016/12/20/flow-cookbook.html">Flow Cookbook</a>
      </li>
    
      <li class="post">
        <a href="/2015/05/31/type-checking-react-with-flow.html">Type checking React with Flow v0.11</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Talks</h1>
  <ul id="talks">
    <li><a href="http://opensourcebridge.org/sessions/1067">Mod your Android</a></li>
    <li><a href="talks/intro-to-javascript/">Introduction to JavaScript</a></li>
    <li><a href="http://lanyrd.com/2012/nodepdx/smyqm/">Object-oriented patterns in JavaScript</a></li>
    <li><a href="talks/cookies/">Cookies are bad for you</a></li>
    <li><a href="talks/professional-javascript/">Professional JavaScript</a></li>
    <li><a href="http://opensourcebridge.org/2009/wiki/Clustering_Data_--_How_to_Have_Fun_in_n-Dimensions">Cluster Analysis: How to Have Fun in n Dimensions</a></li>
    <li><a href="https://docs.google.com/presentation/d/1hx9Pzo07aAnZ2skMH4JPjH7a6IXx64uC0zRliS3qpkk/edit?usp=sharing">How to build blazing fast web apps with Ruby on Rails</a></li>
  </ul>
</section>
<section>
  <h1>Open Source Projects</h1>
  <ul id="projects">
    <li><a href="http://github.com/jivesoftware/tAMD">tAMD:</a> Tiny, extensible implementation of the Asynchronous Module Definition (AMD) specification from CommonJS</li>
  </ul>
</section>
<section>
  <div class="contact" style="float:left; margin:0.5em;">
    <p>
      Jesse Hallett<br/>
      <a href="mailto:jesse@sitr.us">jesse@sitr.us</a>
    </p>
  </div>
  <div class="contact" style="float:left; margin:0.5em;">
    <p>
      <a rel="me" href="https://github.com/hallettj/">github.com/hallettj</a><br />
      <a rel="me" href="https://twitter.com/hallettj/">twitter.com/hallettj</a>
    </p>
  </div>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Jesse Hallett -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'hallettj';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
